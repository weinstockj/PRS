var documenterSearchIndex = {"docs":
[{"location":"#PRSFNN","page":"Home","title":"PRSFNN","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"(Image: logo)","category":"page"},{"location":"","page":"Home","title":"Home","text":"PRSFNN (Polygenic Risk Score with Functional Neural Networks) is a Julia module for calculating polygenic risk scores by integrating GWAS summary statistics with functional annotations using neural networks.","category":"page"},{"location":"#Features","page":"Home","title":"Features","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"Integration of GWAS summary statistics with functional annotations\nLinkage disequilibrium (LD) calculation and correction\nCoordinate Ascent Variational Inference (CAVI) for posterior effect size estimation\nNeural network models to learn the relationship between functional annotations and genetic effect sizes","category":"page"},{"location":"#PRSFNN-runner","page":"Home","title":"PRSFNN runner","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"Note: this Julia module is used for running PRSFNN in individual LD blocks and training the neural network. To run PRSFNN genome-wide is an HPC environment, see our workflow here. ","category":"page"},{"location":"#Installation","page":"Home","title":"Installation","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"# From the Julia REPL\nusing Pkg\nPkg.add(url=\"https://github.com/weinstockj/PRS.jl\")","category":"page"},{"location":"#Getting-Started","page":"Home","title":"Getting Started","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"Steps to load this module from the root directory:","category":"page"},{"location":"","page":"Home","title":"Home","text":"Run julia --color=yes --project=. (requires Julia 1.9.0 or later)\nRun using Revise # helpful while developing\nRun using PRSFNN","category":"page"},{"location":"","page":"Home","title":"Home","text":"Now the functions have been loaded.  To call an internal function, use PRSFNN.function_name ","category":"page"},{"location":"","page":"Home","title":"Home","text":"To run Julia in debugger mode: JULIA_DEBUG=PRSFNN julia --color=yes --project=.","category":"page"},{"location":"#Usage","page":"Home","title":"Usage","text":"","category":"section"},{"location":"#Basic-Example","page":"Home","title":"Basic Example","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"using PRSFNN\n\n# Run PRSFNN on a genomic region\nresult = main(\n    output_prefix = \"chr3_block1\",\n    annot_data_path = \"path/to/annotations.parquet\", \n    gwas_data_path = \"path/to/gwas_stats.tsv\",\n    ld_panel_path = \"path/to/ld_panel\"\n)","category":"page"},{"location":"#Simulating-GWAS-Data","page":"Home","title":"Simulating GWAS Data","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"For testing and development, you can simulate GWAS summary statistic data:","category":"page"},{"location":"","page":"Home","title":"Home","text":"# Generate simulated data\nraw = simulate_raw(;N = 10_000, P = 1_000, K = 100, h2 = 0.10)\n# Extract sufficient statistics needed for PRS\nsummary_stats = estimate_sufficient_statistics(raw.X, raw.Y)\n\n# Visualize the true effect size distribution\nusing Plots\nhistogram(raw.β, title=\"True β Distribution\")","category":"page"},{"location":"#Training-a-PRS-Model","page":"Home","title":"Training a PRS Model","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"# Train the PRS model\nXtX = construct_XtX(ss.R, size(ss.X, 2), size(ss.X, 1))\nD = construct_D(XtX)\nXty = construct_Xty(ss.coef, D)\n\nσ2, R2, yty = infer_σ2(\n    summary_stats.BETA, \n    summary_stats.SE, \n    XtX, \n    Xty, \n    size(ss.X, 1), \n    size(ss.X, 2); \n    estimate = true, \n    λ = 0.50 * size(ss.X, 1)\n)\n\nK = size(raw.G, 2)\n\nlayer_1 = Dense(K => H, Flux.softplus; init = Flux.glorot_normal(gain = 0.005))\nlayer_output = Dense(H => 2)\nlayer_output.bias .= [StatsFuns.log(0.001), StatsFuns.logit(0.1)]\nmodel = Chain(layer_1, layer_output)\ninitial_lr = 0.00005\n#    initial_lr = 0.0001\noptim_type = AdamW(0.001)\nopt = Flux.setup(optim_type, model)\n\nPRS = train_until_convergence(\n    summary_stats.BETA_std,\n    summary_stats.SE,\n    summary_stats.R, \n    XtX,\n    Xty,\n    raw.G,\n    model = model,\n    opt = opt,\n    σ2 = σ2,\n    R2 = R2,\n    yty = yty,\n    N = size(summary_stats.X, 1),\n    train_nn = false,\n    max_iter = 5\n)","category":"page"},{"location":"#Documentation","page":"Home","title":"Documentation","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"For more detailed documentation, visit the official documentation site.","category":"page"},{"location":"#Running-the-Tests","page":"Home","title":"Running the Tests","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"Run unit tests with:","category":"page"},{"location":"","page":"Home","title":"Home","text":"julia --project=. test/runtests.jl","category":"page"},{"location":"","page":"Home","title":"Home","text":"or interactively with:","category":"page"},{"location":"","page":"Home","title":"Home","text":"includet(\"test/runtests.jl\")","category":"page"},{"location":"#Contact","page":"Home","title":"Contact","text":"","category":"section"},{"location":"","page":"Home","title":"Home","text":"Please address correspondence to:","category":"page"},{"location":"","page":"Home","title":"Home","text":"Josh Weinstock <josh.weinstock@emory.edu>\nApril Kim <aprilkim@jhu.edu>\nAlexis Battle <ajbattle@jhu.edu>","category":"page"},{"location":"#Functions","page":"Home","title":"Functions","text":"","category":"section"},{"location":"#PRSFNN.main","page":"Home","title":"PRSFNN.main","text":"PRSFNN\n\nThis function defines the command line interface for the PRSFNN package.\n\nArguments\n\noutput_prefix: A prefix for the output files\nannot_data_path: A path to the directory containing the annotations\nld_panel_path: A path to the directory containing the LD reference panel \ngwas_data_path: A path to the GWAS summary statistics file \nmodel_file: A path to the file containing the trained model \nbetas_output_file: A path to the file where the PRS betas will be saved \ninterpretation_output_file: A path to the file where the interpretation of the model will be saved\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.rss","page":"Home","title":"PRSFNN.rss","text":"rss(β, coef, Σ, SRSinv, to)\n\nCalculate the summary statistic RSS likelihood.\n\nArguments\n\nβ::Vector: Vector of effect sizes.\ncoef::Vector: Observed coefficients.\nΣ::AbstractPDMat: Positive definite covariance matrix.\nSRSinv::Matrix: Precomputed matrix for efficiency.\nto: Timer object for benchmarking.\n\nReturns\n\nFloat64: Log likelihood value.\n\nExample\n\nrss(\n    [0.0011, 0.0052, 0.0013],\n    [-0.019, 0.013, -0.0199],\n    PDMat(Σ),\n    SRSinv,\n    TimerOutput()\n)\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.elbo","page":"Home","title":"PRSFNN.elbo","text":"elbo(z, q_μ, log_q_var, coef, SE, R, σ2_β, p_causal, σ2, [spike_σ2], to)\n\nCompute the Evidence Lower Bound (ELBO) for variational inference.\n\nArguments\n\nz::Vector: Random vector from standard normal distribution.\nq_μ::Vector: Mean vector of the variational distribution.\nlog_q_var::Vector: Log variance vector of the variational distribution.\ncoef::Vector: Observed coefficients.\nSE::Vector or Σ::AbstractPDMat: Standard errors or covariance matrix.\nR::AbstractArray or SRSinv::Matrix: Correlation matrix or precomputed matrix.\nσ2_β::Vector: Vector of prior variances for effect sizes.\np_causal::Vector: Vector of prior probabilities that each SNP is causal.\nσ2::Real: Global variance parameter.\nspike_σ2::Real: Optional variance parameter for the spike component.\nto: Timer object for benchmarking.\n\nReturns\n\nFloat64: Computed ELBO value.\n\nExample\n\nelbo(\n    rand(Normal(0, 1), 3),\n    [0.01, -0.003, 0.0018],\n    [-9.234, -9.24, -9.24],\n    [0.023, -0.0009, -0.0018],\n    [0.0094, 0.00988, 0.0102],\n    [1.0 0.03 0.017; 0.031 1.0 -0.03; 0.017 -0.02 1.0],\n    [0.01, 0.01, 0.01],\n    [0.10, 0.10, 0.10],\n    0.01,\n    TimerOutput()\n)\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.joint_log_prob","page":"Home","title":"PRSFNN.joint_log_prob","text":"joint_log_prob(β, coef, SE, R, σ2_β, p_causal, σ2, [to])\n\nCompute the joint log probability of the model combining likelihood and prior.\n\nArguments\n\nβ::Vector: Vector of effect sizes.\ncoef::Vector: Observed coefficients.\nSE::Vector or Σ::AbstractPDMat: Standard errors or covariance matrix.\nR::Matrix or SRSinv::Matrix: Correlation matrix or precomputed matrix.\nσ2_β::Vector: Vector of prior variances for effect sizes.\np_causal::Vector: Vector of prior probabilities that each SNP is causal.\nσ2::Real: Global variance parameter.\nspike_σ2::Real: Optional variance parameter for the spike component.\nto: Timer object for benchmarking.\n\nReturns\n\nFloat64: Joint log probability.\n\nExample\n\njoint_log_prob(\n    [0.0011, 0.0052, 0.0013],\n    [-0.019, 0.013, -0.0199],\n    [0.0098, 0.0098, 0.0102],\n    [1.0 0.03 0.017; 0.031 1.0 -0.03; 0.017 -0.02 1.0],\n    [0.01, 0.01, 0.01],\n    [0.10, 0.10, 0.10],\n    0.01,\n    TimerOutput()\n)\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.train_until_convergence","page":"Home","title":"PRSFNN.train_until_convergence","text":"`train_until_convergence(coef, SE, R, D, G; max_iter = 20, threshold = 0.1, N = 10_000)`\n\n# Arguments\n- `coef::Vector`: A length P vector of effect sizes\n- `SE::Vector`: A length P vector of standard errors\n- `R::AbstractArray`: A P x P correlation matrix\n- `D::Vector`: A length P vector of the sum of squared genotypes\n- `G::AbstractArray`: A P x K matrix of annotations\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.fit_heritability_nn","page":"Home","title":"PRSFNN.fit_heritability_nn","text":"fitheritabilitynn(model, qμ, qμsq, qalpha, G)\n\nFit the heritability neural network model.\n\nArguments\n\nmodel::Chain: A neural network model\nq_μ::Vector: A length P vector of posterior means\nq_μ_sq::Vector: A length P vector of posterior variances\nq_α::Vector: A length P vector of posterior probabilities of being causal\nG::AbstractArray: A P x K matrix of annotations\n\n    model = Chain(\n        Dense(20 => 5, relu; init = Flux.glorot_normal(gain = 0.0005)),\n        Dense(5 => 2)\n    )\n\n    G = rand(Normal(0, 1), 100, 20)\n    q_μ_sq = (G * rand(Normal(0, 0.10), 20)) .^ 2\n    q_α = 1.0 ./ (1.0 .+ exp.(-1.0 .* (-2.0 .+ q_μ_sq)))\n    trained_model = PRSFNN.fit_heritability_nn(\n        model, \n        q_μ_sq, \n        q_α, \n        G\n    )\n    yhat = transpose(trained_model(transpose(G)))\n    yhat[:, 1] .= exp.(yhat[:, 1])\n    yhat[:, 2] .= 1.0 ./ (1.0 .+ exp.(-yhat[:, 2]))\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.log_prior","page":"Home","title":"PRSFNN.log_prior","text":"log_prior(β, σ2_β, p_causal, σ2, spike_σ2, to)\n\nCalculate the log density of β based on a spike and slab prior.\n\nArguments\n\nβ::Vector: Vector of effect sizes.\nσ2_β::Vector: Vector of prior variances for effect sizes.\np_causal::Vector: Vector of prior probabilities that each SNP is causal.\nσ2::Real: Global variance parameter.\nspike_σ2::Real: Variance parameter for the spike component.\nto: Timer object for benchmarking.\n\nReturns\n\nFloat64: Log prior density.\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.estimate_sufficient_statistics","page":"Home","title":"PRSFNN.estimate_sufficient_statistics","text":"estimate_sufficient_statistics(X, Y)\n\nEstimate the sufficient statistics for genetic association analysis from genotypes and phenotypes.\n\nArguments\n\nX::AbstractArray: Genotype matrix (N×P) where N is the number of samples and P is the number of SNPs.\nY::Vector: Phenotype vector of length N.\n\nReturns\n\nA named tuple containing:\n\ncoef::Vector: Regression coefficients for each SNP.\nSE::Vector: Standard errors of the regression coefficients.\nZ::Vector: Z-scores (coef/SE) for each SNP.\nR::Matrix: Correlation matrix of the genotypes (LD matrix).\nD::Vector: Sum of squares for each SNP (diagonal of X'X).\n\nDescription\n\nThis function computes the basic summary statistics needed for genetic association analysis, including marginal effect sizes, standard errors, test statistics, and the correlation  structure between variants.\n\nExample\n\nX = randn(1000, 100)  # 1000 samples, 100 SNPs\nY = randn(1000)       # Phenotypes\nstats = estimate_sufficient_statistics(X, Y)\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.compute_LD","page":"Home","title":"PRSFNN.compute_LD","text":"compute_LD(LD_reference::String)\n\nCompute linkage disequilibrium (LD) correlation matrix from a reference genotype file.\n\nArguments\n\nLD_reference::String: Path to the BED format genotype file\n\nReturns\n\nR::Matrix{Float64}: LD correlation matrix for polymorphic variants\nsds::Vector{Float64}: Standard deviations of genotypes for each variant\nallele_freq::Vector{Float64}: Allele frequencies (mean/2) for each variant\ngood_variants::Vector{Int}: Indices of polymorphic variants that passed QC filters\n\nDetails\n\nThis function reads genotype data from a BED file, converts it to floating point representation, filters out monomorphic variants and those with very low variance, and computes the correlation matrix between the remaining variants. Variants are filtered based on mean frequency and standard deviation thresholds.\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.fit_genome_wide_nn","page":"Home","title":"PRSFNN.fit_genome_wide_nn","text":"fitgenomewidenn(betas, annotationfilesdir, modelfile; nepochs, H, ntest, learningratedecay, patience)\n\nTrain a neural network model to predict variant effects using genome-wide annotation data.\n\nArguments\n\nbetas: Path to file containing PRS beta values from previous analysis\nannotation_files_dir: Directory containing annotation parquet files\nmodel_file: Path where the trained model will be saved\nn_epochs: Number of training epochs (default: 1306)\nH: Number of hidden units in the neural network (default: 3)\nn_test: Number of test samples to use for evaluation (default: 30)\nlearning_rate_decay: Learning rate decay factor (default: 0.98)\npatience: Number of epochs to wait before reducing learning rate (default: 30)\n\nReturns\n\nmodel: The trained neural network model\nopt: The optimizer state\nglobal_σ2: Global residual variance estimate\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.train_cavi","page":"Home","title":"PRSFNN.train_cavi","text":"train_cavi(p_causal, σ2_β, coef, SE, R, XtX, Xty, to; P = 1_000, n_elbo = 10, max_iter = 5, N = 10_000, yty = 10_000, spike_σ2 = 1e-6, update_σ2 = true, σ2 = 1.0)\n\nPerforms Coordinate Ascent Variational Inference (CAVI) for a spike-and-slab model to estimate genetic variant effect sizes and posterior inclusion probabilities.\n\nArguments\n\np_causal::Vector{Float64}: Prior probabilities for variants to be causal\nσ2_β::Vector{Float64}: Prior variances for effect sizes (slab component)\ncoef::Vector{Float64}: Effect sizes from GWAS summary statistics\nSE::Vector{Float64}: Standard errors of the effect sizes\nR::Matrix{Float64}: LD correlation matrix\nXtX::Matrix{Float64}: Matrix equal to N times the covariance matrix of genotypes\nXty::Vector{Float64}: Vector of inner products between genotypes and phenotype\nto::TimerOutput: Timer output object for performance profiling\n\nKeyword Arguments\n\nP::Int64=1_000: Number of variants\nn_elbo::Int64=10: Number of Monte Carlo samples for ELBO estimation\nmax_iter::Int64=5: Maximum number of iterations for convergence\nN::Float64=10_000: Sample size\nyty::Float64=10_000: Sum of squared phenotypes\nspike_σ2::Float64=1e-6: Variance for the spike component\nupdate_σ2::Bool=true: Whether to update the residual variance\nσ2::Float64=1.0: Initial residual variance\n\nReturns\n\nA named tuple containing:\n\nq_μ::Vector{Float64}: Posterior means for the slab component\nq_spike_μ::Vector{Float64}: Posterior means for the spike component\nq_α::Vector{Float64}: Posterior inclusion probabilities\nq_var::Vector{Float64}: Posterior variances for the slab component\nq_odds::Vector{Float64}: Posterior odds for variant inclusion\nloss::Float64: Final ELBO value\nse_loss::Float64: Standard error of the ELBO estimate\nσ2::Float64: Final residual variance estimate\n\nDetails\n\nThis function implements an iterative Coordinate Ascent Variational Inference algorithm for a  spike-and-slab model, commonly used in Polygenic Risk Score (PRS) calculation. At each iteration, it updates the variational parameters to maximize the Evidence Lower Bound (ELBO).\n\nThe algorithm stops when insufficient improvement in ELBO is detected or when the maximum number of iterations is reached. The best parameters (with highest ELBO) are returned.\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.simulate_raw","page":"Home","title":"PRSFNN.simulate_raw","text":"simulate_raw(; N = 10_000, P = 1_000, K = 100, h2 = 0.10)\n\nSimulate genotype and phenotype data with genetic architecture influenced by functional annotations.\n\nArguments\n\nN::Int=10_000: Number of samples/individuals\nP::Int=1_000: Number of genetic variants/SNPs\nK::Int=100: Number of functional annotations\nh2::Float64=0.10: Desired narrow-sense heritability of the trait\n\nReturns\n\nA named tuple containing:\n\nX::Matrix{Float64}: Genotype matrix (N × P)\nβ::Vector{Float64}: True causal effect sizes\nY::Vector{Float64}: Simulated phenotypes\nΣ::Matrix{Float64}: Covariance matrix of genotypes (LD structure)\ns::Vector{Float64}: Per-SNP normalized variance scalars derived from annotations\nG::Matrix{Float64}: Matrix of functional annotations (P × K)\nγ::Vector{Int}: Binary indicators of causal status (1=causal, 0=non-causal)\nfunction_choices::Vector{Int}: Selected functional forms for each annotation\nphi::Vector{Function}: Functions mapping each annotation to effect size variance\nsigma_squared::Vector{Float64}: Per-SNP variance components before normalization\n\nDetails\n\nThis function simulates genotype and phenotype data with a realistic genetic architecture:\n\nGenotypes (X) are simulated with a realistic LD structure using random eigendecomposition\n10% of variants are designated as causal (γ)\nFunctional annotations (G) influence effect size variance through different functional forms\nEffect sizes follow a spike-and-slab distribution:\nCausal variants: Normal(0, scaled_variance)\nNon-causal variants: Normal(0, tiny_variance)\nPhenotypes are computed as Y = Xβ + ε, with noise calibrated to achieve target heritability\n\nThe simulation includes both continuous and binary annotations, with varying relationships to effect size variance (linear, quadratic, or null effects).\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.infer_σ2","page":"Home","title":"PRSFNN.infer_σ2","text":"`infer_σ2(coef, SE, R, D, X_sd, N, P)`\n\n# Arguments\n- `coef::Vector`: A length P vector of effect sizes\n- `SE::Vector`: A length P vector of standard errors\n- `XtX::AbstractArray`: A P x P matrix equal to N times the covariance matrix of the genotypes\n- `Xty::Vector`: A length P vector of the inner product between genotype and phenotype\n- `N`: Number of samples\n- `P`: Number of SNPs\n\n\n\n\n\n","category":"function"},{"location":"#PRSFNN.poet_cov","page":"Home","title":"PRSFNN.poet_cov","text":"poet_cov(X::AbstractArray; K = 100, τ = 0.01, N = 1000)\n\nApply POET (Principal Orthogonal complEment Thresholding) method to estimate a sparse covariance matrix.\n\nArguments\n\nX::AbstractArray: Input covariance or correlation matrix\nK::Int=100: Number of principal components to retain\nτ::Float64=0.01: Thresholding parameter for sparsity\nN::Int=1000: Sample size used for bias correction\n\nReturns\n\nSigma::Matrix{Float64}: The POET-estimated covariance matrix\n\nDetails\n\nImplements the POET method for high-dimensional covariance matrix estimation. The method decomposes the matrix into a low-rank component (representing systematic factors) and a sparse component (representing idiosyncratic noise). The sparse component is obtained by thresholding.\n\nReference: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5563862/\n\n\n\n\n\n","category":"function"}]
}
